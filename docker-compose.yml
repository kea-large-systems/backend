version: '2'

services:
  app:
    build:
      context: .
      dockerfile: ./docker/app/Dockerfile
    env_file:
      - ./docker/app/.env
    ports:
      - 4200:4200
    depends_on:
      mysql:
        condition: service_healthy
    mem_limit: 300m
    mem_reservation: 100m
    cpus: 0.3
    cpu_shares: 512

  mysql:
    build:
      context: .
      dockerfile: ./docker/mysql/Dockerfile
    env_file:
      - ./docker/mysql/.env
    ports:
      - 3306:3306
    healthcheck:
      test: ["CMD-SHELL", "/usr/bin/mysql --user=$DB_USERNAME --password=$DB_PASSWORD --execute 'SHOW DATABASES';"]
      interval: 4s
      timeout: 2s
      retries: 10
      start_period: 3s